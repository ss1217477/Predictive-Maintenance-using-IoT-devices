<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Predictive Maintenance Dashboard</title> <!-- External Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/raphael/2.3.0/raphael.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/justgage@1.3.2/justgage.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.0/dist/chart.min.js"></script> <!-- Google Font -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        /* General Styles */
        body {
            font-family: 'Roboto', sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f6f9;
            color: #333;
        }

        .container {
            width: 90%;
            max-width: 1200px;
            margin: 30px auto;
        }

        h1 {
            font-size: 2rem;
            text-align: center;
            margin-bottom: 30px;
            color: #34495e;
        }

        /* Dashboard Layout */
        .dashboard {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: space-between;
        }

        .card {
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            flex: 1;
            min-width: 300px;
        }

        .card.large {
            flex: 2;
        }

        /* Notification Box */
        .notification-box {
            font-size: 1.2rem;
            padding: 15px;
            text-align: center;
            color: white;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            display: none;
        }

        .notification-box.safe {
            background-color: #2ecc71;
            /* Green */
        }

        .notification-box.warning {
            background-color: #f39c12;
            /* Yellow */
        }

        .notification-box.critical {
            background-color: #e74c3c;
            /* Red */
        }

        .log-container {
            max-height: 200px;
            overflow-y: auto;
            border-top: 1px solid #eee;
            margin-top: 10px;
            padding-top: 10px;
        }

        .log-container p {
            margin: 5px 0;
            font-size: 0.9rem;
            color: #555;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .dashboard {
                flex-direction: column;
            }

            .card.large {
                flex: 1;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>Predictive Maintenance Dashboard</h1> <!-- Notification Box -->
        <div id="notification-box" class="notification-box"></div> <!-- Dashboard -->
        <div class="dashboard"> <!-- Temperature Chart -->
            <div class="card large">
                <h2>Temperature Graph</h2> <canvas id="temperature-chart"></canvas>
            </div> <!-- Temperature Gauge -->
            <div class="card">
                <h2>Temperature Gauge</h2>
                <div id="temp-gauge"></div>
            </div>
        </div> <!-- Summary Section -->
        <div class="dashboard"> <!-- Average Temperature Logs -->
            <div class="card large">
                <h2>Average Temperature Logs</h2>
                <div id="average-value">Average: -- °C</div>
                <div id="min-value">Min: -- °C</div>
                <div id="max-value">Max: -- °C</div>
                <div class="log-container" id="log-container"></div> <button onclick="clearLogs()">Clear Logs</button>
            </div> <!-- Set Alert Threshold -->
            <div class="card">
                <h2>Set Alert Threshold</h2>
                <div class="threshold-box"> <input type="number" id="threshold" value="25" step="1"> <button
                        onclick="updateThreshold()">Save</button> </div>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function () {
        let temperatureData = [];
        let totalTemperature = 0;
        let minTemperature = Infinity;
        let maxTemperature = -Infinity;
        let readingCount = 0;
        let startTime = Date.now();

        const logContainer = document.getElementById('log-container');
        const tempGauge = new JustGage({
            id: "temp-gauge",
            value: 0,
            min: 0,
            max: 50,
            title: "Current Temperature (°C)"
        });
        const ctx = document.getElementById('temperature-chart').getContext('2d');
        const tempChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: "Temperature (°C)",
                    data: [],
                    borderColor: "blue",
                    fill: false
                }]
            },
            options: {
                responsive: true,
                scales: {
                    x: { type: 'linear', position: 'bottom' },
                    y: { beginAtZero: true }
                }
            }
        });

        // Load threshold from localStorage or default to 25
        let alertThreshold = parseInt(localStorage.getItem('alertThreshold')) || 25;
        document.getElementById('threshold').value = alertThreshold;

        // Load logs from localStorage
        let logs = JSON.parse(localStorage.getItem('logs')) || [];
        logs.forEach(log => appendLog(log)); // Display existing logs on page load

        async function fetchTemperature() {
            try {
                const response = await fetch('http://localhost:3001/latest-data');
                const data = await response.json();
                const temperature = parseFloat(data.temperature);
                if (isNaN(temperature)) return;
                const elapsedTime = ((Date.now() - startTime) / 1000).toFixed(1);
                tempGauge.refresh(temperature);
                temperatureData.push(temperature);
                tempChart.data.labels.push(elapsedTime);
                tempChart.data.datasets[0].data.push(temperature);
                tempChart.update();
                totalTemperature += temperature;
                readingCount++;
                minTemperature = Math.min(minTemperature, temperature);
                maxTemperature = Math.max(maxTemperature, temperature);
                updateNotificationBox(temperature);
            } catch (error) {
                console.error("Error fetching temperature:", error);
            }
        }

        function updateNotificationBox(temperature) {
            const notificationBox = document.getElementById('notification-box');
            if (temperature > alertThreshold + 5) {
                notificationBox.textContent = `Critical: ${temperature}°C exceeds dangerous limit!`;
                notificationBox.className = 'notification-box critical';
                notificationBox.style.display = 'block';
            } else if (temperature > alertThreshold) {
                notificationBox.textContent = `Warning: ${temperature}°C exceeds threshold!`;
                notificationBox.className = 'notification-box warning';
                notificationBox.style.display = 'block';
            } else {
                notificationBox.style.display = 'none';
            }
        }

        window.updateThreshold = function () {
            alertThreshold = parseInt(document.getElementById('threshold').value, 10);
            localStorage.setItem('alertThreshold', alertThreshold); // Save to localStorage
            alert("Threshold updated!");
        };

        function appendLog(log) {
            const logEntry = document.createElement('p');
            logEntry.textContent = log;
            logContainer.prepend(logEntry);
        }

        window.clearLogs = function () {
            logs = []; // Clear logs array
            localStorage.setItem('logs', JSON.stringify(logs)); // Update localStorage
            logContainer.innerHTML = ''; // Clear displayed logs
            alert('Logs cleared!');
        };

        // Log average temperature every 100 seconds
        setInterval(() => {
            if (readingCount > 0) {
                const averageTemperature = (totalTemperature / readingCount).toFixed(2);
                const logEntry = `Avg: ${averageTemperature}°C, Min: ${minTemperature}°C, Max: ${maxTemperature}°C`;
                // Add to logs and limit to 10 entries
                logs.push(logEntry);
                if (logs.length > 10) logs.shift(); // Remove the oldest log if over 10
                // Update localStorage
                localStorage.setItem('logs', JSON.stringify(logs));
                // Clear and re-display logs
                logContainer.innerHTML = '';
                logs.forEach(log => appendLog(log));
            }
            // Reset values for the next 100-second interval
            totalTemperature = 0;
            readingCount = 0;
            temperatureData = [];
            minTemperature = Infinity;
            maxTemperature = -Infinity;
            tempChart.data.labels = [];
            tempChart.data.datasets[0].data = [];
            tempChart.update();
            startTime = Date.now();
        }, 100000); // 100 seconds in milliseconds

        // Fetch temperature data every 1 second
        setInterval(fetchTemperature, 1000);
    });
    </script>
</body>

</html>